<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bem-vindo!</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f4f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .welcome {
            background: #fff;
            padding: 30px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
        }
        .success {
            color: #2e7d32;
            font-weight: bold;
            margin-top: 10px;
        }
        .user-name {
            color: #1976d2;
            font-size: 1.3em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header style="width:100%;background:#1976d2;color:#fff;padding:16px 0 16px 32px;position:fixed;top:0;left:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.07);font-size:1.2em;display:flex;align-items:center;justify-content:flex-start;">
        <span style="flex:1;text-align:left;">Olá, <span id="header-user-name"></span></span>
        <button id="hacker-btn" style="background:none;border:none;padding:0;cursor:pointer;position:absolute;left:50%;transform:translateX(-50%);">
            <img src="./imagens/iconehacker.webp" alt="Ícone Hacker" style="height:48px;width:auto;display:block;" />
        </button>
    </header>
    <script>
        const userName = localStorage.getItem('user_name');
        document.getElementById('header-user-name').textContent = userName ? userName : 'Usuário';
    </script>
    <div id="conteudo-texto-main" style="max-width:700px;margin:90px auto 0 auto;padding:24px;display:none;background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);"></div>
    <div id="disciplina-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:2000;align-items:center;justify-content:center;">
      <div style="position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <button id="close-modal" style="position:absolute;top:-40px;right:0;font-size:2em;background:none;border:none;cursor:pointer;z-index:10;">&times;</button>
        <h2 style="margin-top:0;text-align:center;color:#fff;">Disciplinas</h2>
        <div id="pizza" style="position:relative;width:380px;height:380px;border-radius:50%;background:transparent;box-shadow:0 8px 32px rgba(0,0,0,0.18);overflow:visible;"></div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
    const SUPABASE_URL = 'https://zzrylgsjksrjotgcwavt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6cnlsZ3Nqa3Nyam90Z2N3YXZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4Mjc0OTYsImV4cCI6MjA2NDQwMzQ5Nn0.caBlCmOqKonuxTPacPIHH1FeVZFr8AJKwpz_v1Q3BwM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const pizzaColors = [
      "#FFD700", "#FF6347", "#90EE90", "#87CEEB", "#FFB6C1", "#FFA07A", "#20B2AA", "#9370DB", "#F08080", "#40E0D0"
    ];

    function describeArc(cx, cy, r, startAngle, endAngle){
        var start = polarToCartesian(cx, cy, r, endAngle);
        var end = polarToCartesian(cx, cy, r, startAngle);
        var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
        var d = [
            "M", cx, cy,
            "L", start.x, start.y, 
            "A", r, r, 0, largeArcFlag, 0, end.x, end.y,
            "Z"
        ].join(" ");
        return d;       
    }

    function polarToCartesian(cx, cy, r, angleInDegrees) {
        var angleInRadians = (angleInDegrees-90) * Math.PI / 180.0;
        return {
            x: cx + (r * Math.cos(angleInRadians)),
            y: cy + (r * Math.sin(angleInRadians))
        };
    }

    document.getElementById('hacker-btn').addEventListener('click', async function() {
        const modal = document.getElementById('disciplina-modal');
        const pizza = document.getElementById('pizza');
        pizza.innerHTML = '<div style="text-align:center;width:100%;margin-top:160px;">Carregando...</div>';
        modal.style.display = 'flex';

        // Busca as disciplinas
        const { data, error } = await supabase.from('disciplina').select('*');
        if (error || !data || data.length === 0) {
            pizza.innerHTML = '<div style="text-align:center;width:100%;margin-top:160px;color:red;">Nenhuma disciplina encontrada.</div>';
            return;
        }

        // SVG pizza
        const n = data.length;
        const cx = 190, cy = 190, r = 180;
        let svg = `<svg width=\"380\" height=\"380\" viewBox=\"0 0 380 380\" style=\"border-radius:50%;overflow:visible;\">`;

        for(let i=0; i<n; i++) {
            const startAngle = (i * 360 / n);
            const endAngle = ((i+1) * 360 / n);
            const color = pizzaColors[i % pizzaColors.length];
            svg += `<path d=\"${describeArc(cx, cy, r, startAngle, endAngle)}\" fill=\"${color}\" stroke=\"#fff\" stroke-width=\"2\" style=\"cursor:pointer;\" data-id=\"${data[i].id}\"/>`;

            // Texto centralizado na fatia
            const midAngle = (startAngle + endAngle) / 2;
            const textRadius = r * 0.6;
            const tx = cx + textRadius * Math.cos((midAngle-90)*Math.PI/180);
            const ty = cy + textRadius * Math.sin((midAngle-90)*Math.PI/180);

            svg += `
                <text x=\"${tx}\" y=\"${ty-10}\" text-anchor=\"middle\" alignment-baseline=\"middle\" font-size=\"14\" font-weight=\"bold\" fill=\"#222\">${data[i].nome}</text>
                <text x=\"${tx}\" y=\"${ty+8}\" text-anchor=\"middle\" alignment-baseline=\"middle\" font-size=\"11\" fill=\"#333\">${data[i].date}</text>
                <text x=\"${tx}\" y=\"${ty+22}\" text-anchor=\"middle\" alignment-baseline=\"middle\" font-size=\"11\" fill=\"#333\">${data[i].situation}</text>
            `;
        }
        svg += `</svg>`;
        pizza.innerHTML = svg;

        // Adiciona evento de clique nas fatias
        setTimeout(() => {
          document.querySelectorAll('#pizza path[data-id]').forEach(path => {
            path.addEventListener('click', async function(e) {
              const disciplinaId = this.getAttribute('data-id');
              // Busca textos associados à disciplina
              const { data: textos, error: errorText } = await supabase
                .from('text')
                .select('*')
                .eq('id_disciplina', disciplinaId);

              // Fecha o modal
              document.getElementById('disciplina-modal').style.display = 'none';

              // Mostra conteúdo ou mensagem
              const conteudoDiv = document.getElementById('conteudo-texto-main');
              if (errorText || !textos || textos.length === 0) {
                conteudoDiv.style.display = 'block';
                conteudoDiv.innerHTML = '<div style="color:#b00;font-size:1.1em;text-align:center;">Essa disciplina ainda não tem conteúdo.</div>';
              } else {
                const t = textos[0];
                conteudoDiv.style.display = 'block';
                conteudoDiv.innerHTML = `
                  <button onclick=\"this.parentNode.style.display='none'\" style=\"position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;\">&times;</button>
                  <h2 style=\"margin-top:0\">${t.title}</h2>
                  <p>${t.complete_text}</p>
                  ${t.image ? `<img src=\"${t.image}\" alt=\"\" style=\"max-width:100%;margin-top:16px;border-radius:8px;\">` : ''}
                `;
              }
            });
          });
        }, 100);
    });

    // Fecha o modal
    document.getElementById('close-modal').onclick = function() {
        document.getElementById('disciplina-modal').style.display = 'none';
    };
    </script>
</body>
</html>
