<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bem-vindo!</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f4f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .welcome {
            background: #fff;
            padding: 30px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
        }
        .success {
            color: #2e7d32;
            font-weight: bold;
            margin-top: 10px;
        }
        .user-name {
            color: #1976d2;
            font-size: 1.3em;
            font-weight: bold;
        }
        body.edit-mode #edit-gear-btn {
          background: #1976d2 !important;
        }
        body.edit-mode #edit-gear-btn svg path {
          fill: #fff !important;
        }
        #conteudo-texto-main,
        #conteudo-texto-main.videos-mode {
          padding-top: 90px;
          margin-left: auto;
          margin-right: auto;
          margin-top: 0;
          max-width: 1200px;
          width: 96vw;
          padding: 24px;
          display: none;
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 2px 12px rgba(0,0,0,0.08);
          position: relative;
          word-break: break-word;
          overflow-wrap: break-word;
        }
        #conteudo-texto-main h2,
        #conteudo-texto-main p {
          max-width: 100%;
          word-break: break-word;
          overflow-wrap: break-word;
          white-space: pre-line;
        }
        #conteudo-texto-main img,
        #conteudo-texto-main iframe {
          max-width: 100%;
          width: 100%;
          height: auto;
          display: block;
          margin: 16px 0;
          border-radius: 8px;
        }
        @media (max-width: 800px) {
          #conteudo-texto-main,
          #conteudo-texto-main.videos-mode {
            max-width: 99vw;
            width: 99vw;
            padding: 10px;
            font-size: 0.98em;
          }
          #conteudo-texto-main .registro-title,
          #conteudo-texto-main .registro-text {
            font-size: 0.98em;
          }
          #conteudo-texto-main iframe {
            height: 220px !important;
          }
        }
        #conteudo-texto-main .registro {
          display: block;
          margin-bottom: 0.7em;
          line-height: 1.6;
        }
        #conteudo-texto-main .registro-title {
          color: #111;
          font-size: 1em;
          font-weight: bold;
          display: inline-block;
          margin-bottom: 0.1em;
          margin-right: 0.5em;
          vertical-align: middle;
        }
        #conteudo-texto-main .registro-text {
          display: inline;
          color: #222;
          font-size: 1em;
          vertical-align: middle;
        }
        #conteudo-texto-main .registro-img {
          display: block;
          max-width: 100%;
          margin: 8px 0 8px 0;
          border-radius: 8px;
        }
        #conteudo-texto-main .crud-btn {
          background: none;
          border: none;
          cursor: pointer;
          font-size: 0.95em;
          color: #888;
          padding: 2px 6px;
          border-radius: 4px;
          transition: background 0.2s;
        }
        #conteudo-texto-main .crud-btn.delete { color: #b00; }
        #conteudo-texto-main .crud-btn:hover { background: #f0f0f0; }
        #conteudo-texto-main .registro-toolbar {
          display: flex;
          justify-content: flex-end;
          gap: 8px;
          margin-bottom: 2px;
        }
        #extra-content-btn {
          position: fixed;
          top: 180px;
          left: 24px;
          z-index: 3002;
          background: #fff;
          border-radius: 50%;
          border: none;
          box-shadow: 0 2px 8px rgba(0,0,0,0.18);
          width: 48px;
          height: 48px;
          display: none;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: box-shadow 0.2s;
        }
        #extra-content-btn svg {
          width: 28px;
          height: 28px;
        }
        #extra-content-menu {
          position: fixed;
          top: 235px;
          left: 24px;
          z-index: 3003;
          background: #fff;
          border-radius: 10px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.18);
          display: none;
          flex-direction: column;
          min-width: 120px;
          padding: 6px 0;
          animation: fadeInMenu 0.2s;
        }
        #extra-content-menu button {
          background: none;
          border: none;
          width: 100%;
          text-align: left;
          padding: 8px 18px;
          font-size: 1.05em;
          cursor: pointer;
          transition: background 0.2s;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        #extra-content-menu button:hover {
          background: #f0f4f8;
        }
        @keyframes fadeInMenu {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        #conteudo-texto-main.videos-mode {
          padding-top: 32px;
          max-width: 1200px;
          width: 96vw;
        }
        /* Wrapper responsivo para vídeos 16:9 */
        .video-responsive {
          position: relative;
          width: 100%;
          max-width: 900px;
          margin: 32px auto 24px auto;
          padding-bottom: 56.25%; /* 16:9 */
          height: 0;
        }
        .video-responsive iframe {
          position: absolute;
          top: 0; left: 0;
          width: 100%;
          height: 100%;
          border-radius: 8px;
          border: none;
          background: #000;
        }
        @media (max-width: 950px) {
          .video-responsive {
            max-width: 99vw;
          }
        }
    </style>
</head>
<body>
    <header style="width:100%;background:#1976d2;color:#fff;padding:16px 0 16px 32px;position:fixed;top:0;left:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.07);font-size:1.2em;display:flex;align-items:center;justify-content:flex-start;">
        <span style="flex:1;text-align:left;">Olá, <span id="header-user-name"></span></span>
        <button id="hacker-btn" style="background:none;border:none;padding:0;cursor:pointer;position:absolute;left:50%;transform:translateX(-50%);">
            <img src="./imagens/iconehacker.webp" alt="Ícone Hacker" style="height:48px;width:auto;display:block;" />
        </button>
        <button id="logout-btn" style="margin-right:32px;background:#fff;color:#1976d2;border:none;padding:8px 18px;border-radius:6px;font-size:1em;cursor:pointer;transition:background 0.2s;">Sair</button>
    </header>
    <button id="edit-gear-btn" title="Modo edição" style="
      position:fixed;
      top:90px;
      left:24px;
      z-index:3001;
      background:#fff;
      border-radius:50%;
      border:none;
      box-shadow:0 2px 8px rgba(0,0,0,0.18);
      width:56px;
      height:56px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:box-shadow 0.2s;
    ">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
        <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7zm7.43-2.9l1.77-1.02a.5.5 0 0 0 .18-.68l-1.68-2.92a.5.5 0 0 0-.61-.23l-2.08.83a7.03 7.03 0 0 0-1.6-.93l-.31-2.23A.5.5 0 0 0 14 4h-4a.5.5 0 0 0-.5.42l-.31 2.23c-.58.23-1.12.53-1.6.93l-2.08-.83a.5.5 0 0 0-.61.23l-1.68 2.92a.5.5 0 0 0 .18.68l1.77 1.02c-.05.32-.08.65-.08.98s.03.66.08.98l-1.77 1.02a.5.5 0 0 0-.18.68l1.68 2.92a.5.5 0 0 0 .61.23l2.08-.83c.48.4 1.02.7 1.6.93l.31 2.23A.5.5 0 0 0 10 20h4a.5.5 0 0 0 .5-.42l.31-2.23c.58-.23 1.12-.53 1.6-.93l2.08.83a.5.5 0 0 0 .61-.23l1.68-2.92a.5.5 0 0 0-.18-.68l-1.77-1.02c.05-.32.08-.65.08-.98s-.03-.66-.08-.98z" fill="#1976d2"/>
      </svg>
    </button>
    <button id="extra-content-btn" title="Conteúdo extra">
      <svg viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="10" stroke="#1976d2" stroke-width="2"/>
        <path d="M8 12h8M12 8v8" stroke="#1976d2" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <script>
        const userName = localStorage.getItem('user_name');
        document.getElementById('header-user-name').textContent = userName ? userName : 'Usuário';
        document.getElementById('logout-btn').onclick = function() {
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_name');
            window.location.href = 'my_future.html';
        };
    </script>
    <div id="conteudo-texto-main" style="max-width:700px;margin:90px auto 0 auto;padding:24px;display:none;background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);position:relative;"></div>
    <div id="disciplina-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:2000;align-items:center;justify-content:center;">
      <div style="position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <button id="close-modal" style="position:absolute;top:-40px;right:0;font-size:2em;background:none;border:none;cursor:pointer;z-index:10;">&times;</button>
        <h2 style="margin-top:0;text-align:center;color:#fff;">Disciplinas</h2>
        <div id="pizza" style="position:relative;width:380px;height:380px;border-radius:50%;background:transparent;box-shadow:0 8px 32px rgba(0,0,0,0.18);overflow:visible;"></div>
      </div>
    </div>
    <div id="crud-modal-root"></div>
    <div id="extra-content-menu">
      <button id="menu-text-btn">📝 Texto</button>
      <button id="menu-video-btn">🎬 Vídeo</button>
      <button id="menu-practice-btn">🧪 Prática</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
    const SUPABASE_URL = 'https://zzrylgsjksrjotgcwavt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6cnlsZ3Nqa3Nyam90Z2N3YXZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4Mjc0OTYsImV4cCI6MjA2NDQwMzQ5Nn0.caBlCmOqKonuxTPacPIHH1FeVZFr8AJKwpz_v1Q3BwM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const pizzaColors = [
      "#FFD700", "#FF6347", "#90EE90", "#87CEEB", "#FFB6C1", "#FFA07A", "#20B2AA", "#9370DB", "#F08080", "#40E0D0"
    ];

    function describeArc(cx, cy, r, startAngle, endAngle){
        var start = polarToCartesian(cx, cy, r, endAngle);
        var end = polarToCartesian(cx, cy, r, startAngle);
        var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
        var d = [
            "M", cx, cy,
            "L", start.x, start.y, 
            "A", r, r, 0, largeArcFlag, 0, end.x, end.y,
            "Z"
        ].join(" ");
        return d;       
    }

    function polarToCartesian(cx, cy, r, angleInDegrees) {
        var angleInRadians = (angleInDegrees-90) * Math.PI / 180.0;
        return {
            x: cx + (r * Math.cos(angleInRadians)),
            y: cy + (r * Math.sin(angleInRadians))
        };
    }

    document.getElementById('hacker-btn').addEventListener('click', async function() {
        const modal = document.getElementById('disciplina-modal');
        const pizza = document.getElementById('pizza');
        pizza.innerHTML = '<div style="text-align:center;width:100%;margin-top:160px;">Carregando...</div>';
        modal.style.display = 'flex';

        // Busca as disciplinas
        const { data, error } = await supabase.from('disciplina').select('*');
        if (error || !data || data.length === 0) {
            pizza.innerHTML = '<div style="text-align:center;width:100%;margin-top:160px;color:red;">Nenhuma disciplina encontrada.</div>';
            return;
        }

        // SVG pizza
        const n = data.length;
        const cx = 190, cy = 190, r = 180;
        let svg = `<svg width=\"380\" height=\"380\" viewBox=\"0 0 380 380\" style=\"border-radius:50%;overflow:visible;\">`;

        for(let i=0; i<n; i++) {
            const startAngle = (i * 360 / n);
            const endAngle = ((i+1) * 360 / n);
            const color = pizzaColors[i % pizzaColors.length];
            svg += `<path d=\"${describeArc(cx, cy, r, startAngle, endAngle)}\" fill=\"${color}\" stroke=\"#fff\" stroke-width=\"2\" style=\"cursor:pointer;\" data-id=\"${data[i].id}\"/>`;

            // Texto centralizado na fatia
            const midAngle = (startAngle + endAngle) / 2;
            const textRadius = r * 0.6;
            const tx = cx + textRadius * Math.cos((midAngle-90)*Math.PI/180);
            const ty = cy + textRadius * Math.sin((midAngle-90)*Math.PI/180);

            svg += `
                <text x=\"${tx}\" y=\"${ty-10}\" text-anchor=\"middle\" alignment-baseline=\"middle\" font-size=\"14\" font-weight=\"bold\" fill=\"#222\">${data[i].nome}</text>
                <text x=\"${tx}\" y=\"${ty+8}\" text-anchor=\"middle\" alignment-baseline=\"middle\" font-size=\"11\" fill=\"#333\">${data[i].date}</text>
                <text x=\"${tx}\" y=\"${ty+22}\" text-anchor=\"middle\" alignment-baseline=\"middle\" font-size=\"11\" fill=\"#333\">${data[i].situation}</text>
            `;
        }
        svg += `</svg>`;
        pizza.innerHTML = svg;

        // Adiciona evento de clique nas fatias
        setTimeout(() => {
          document.querySelectorAll('#pizza path[data-id]').forEach(path => {
            path.addEventListener('click', async function(e) {
              const disciplinaId = this.getAttribute('data-id');
              // Busca textos associados à disciplina
              const { data: textos, error: errorText } = await supabase
                .from('text')
                .select('*')
                .eq('id_disciplina', disciplinaId);

              // Fecha o modal
              document.getElementById('disciplina-modal').style.display = 'none';

              // Mostra conteúdo ou mensagem
              window.ultimoTextosExibidos = textos;
              window.ultimoDisciplinaIdExibida = disciplinaId;
              renderConteudoAtual(textos, disciplinaId);
            });
          });
        }, 100);
    });

    // Fecha o modal
    document.getElementById('close-modal').onclick = function() {
        document.getElementById('disciplina-modal').style.display = 'none';
    };

    let editMode = false;
    document.getElementById('edit-gear-btn').addEventListener('click', function() {
      editMode = !editMode;
      document.body.classList.toggle('edit-mode', editMode);
      if (window.abaAtiva === 'text' && window.ultimoTextosExibidos && window.ultimoDisciplinaIdExibida) {
        renderConteudoAtual(window.ultimoTextosExibidos, window.ultimoDisciplinaIdExibida);
      } else if (window.abaAtiva === 'video' && window.ultimoDisciplinaIdExibida) {
        document.getElementById('menu-video-btn').onclick();
      } else if (window.abaAtiva === 'practice' && window.ultimoDisciplinaIdExibida) {
        document.getElementById('menu-practice-btn').onclick();
      }
    });

    function renderConteudoAtual(textos = [], disciplinaId = null) {
      const conteudoDiv = document.getElementById('conteudo-texto-main');
      if (!textos.length) {
        conteudoDiv.style.display = 'block';
        conteudoDiv.innerHTML = `
          <div style="color:#b00;font-size:1.1em;text-align:center;margin-bottom:16px;">
            Essa disciplina ainda não tem conteúdo.
          </div>
          <div style="text-align:center;">
            <button onclick="criarTexto(${disciplinaId})" style="font-size:1.1em;padding:8px 18px;border-radius:8px;background:#1976d2;color:#fff;border:none;cursor:pointer;">
              ➕ Adicionar Texto
            </button>
          </div>
        `;
        return;
      }
      conteudoDiv.style.display = 'block';
      conteudoDiv.innerHTML = `<button onclick=\"this.parentNode.style.display='none'\" style=\"position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;\">&times;</button>` +
        textos.map((t, i) => `
          <div class=\"registro\">
            ${editMode ? `
              <div class=\"registro-toolbar\">
                <button onclick=\"editarTexto(${t.id})\" class=\"crud-btn\" title=\"Editar\">✏️</button>
                <button onclick=\"excluirTexto(${t.id},${disciplinaId})\" class=\"crud-btn delete\" title=\"Excluir\">🗑️</button>
              </div>
            ` : ''}
            ${t.title ? `${i > 0 ? '<br>' : ''}<span class=\"registro-title\">${t.title}</span>` : ''}
            ${t.complete_text ? `<span class=\"registro-text\">${t.complete_text}</span>` : ''}
            ${t.image ? `<img src=\"${t.image}\" alt=\"\" class=\"registro-img\">` : ''}
          </div>
        `).join('') +
        (editMode ? `<button onclick=\"criarTexto(${disciplinaId})\" style=\"margin-left:8px;font-size:1em;vertical-align:middle;\">➕ Novo Texto</button>` : '');
      conteudoDiv.classList.remove('videos-mode');
      document.getElementById('extra-content-btn').style.display = 'flex';
    }

    window.criarTexto = function(disciplinaId) {
      document.getElementById('crud-modal-root').innerHTML = `
        <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:4000;display:flex;align-items:center;justify-content:center;">
          <form id="form-novo-texto" style="background:#fff;padding:24px 20px;border-radius:10px;max-width:400px;width:90vw;box-shadow:0 2px 12px rgba(0,0,0,0.12);position:relative;">
            <button type="button" onclick="document.getElementById('crud-modal-root').innerHTML=''" style="position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;">&times;</button>
            <h3>Novo Texto</h3>
            <input name="title" placeholder="Título" style="width:100%;margin-bottom:8px;" />
            <textarea name="complete_text" placeholder="Texto completo" style="width:100%;margin-bottom:8px;"></textarea>
            <input name="image" placeholder="URL da imagem (opcional)" style="width:100%;margin-bottom:8px;" />
            <button type="submit">Salvar</button>
          </form>
        </div>
      `;
      document.getElementById('form-novo-texto').onsubmit = async function(e) {
        e.preventDefault();
        const { title, complete_text, image } = this;
        await supabase.from('text').insert([{ 
          title: title.value, 
          complete_text: complete_text.value, 
          image: image.value, 
          id_disciplina: disciplinaId 
        }]);
        const { data: textos } = await supabase.from('text').select('*').eq('id_disciplina', disciplinaId);
        window.ultimoTextosExibidos = textos;
        renderConteudoAtual(textos, disciplinaId);
        document.getElementById('crud-modal-root').innerHTML = '';
      };
    };
    window.editarTexto = function(id) {
      const t = window.ultimoTextosExibidos.find(x => x.id == id);
      if (!t) return;
      document.getElementById('crud-modal-root').innerHTML = `
        <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:4000;display:flex;align-items:center;justify-content:center;">
          <form id="form-editar-texto" style="background:#fff;padding:24px 20px;border-radius:10px;max-width:400px;width:90vw;box-shadow:0 2px 12px rgba(0,0,0,0.12);position:relative;">
            <button type="button" onclick="document.getElementById('crud-modal-root').innerHTML=''" style="position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;">&times;</button>
            <h3>Editar Texto</h3>
            <input name="title" value="${t.title || ''}" style="width:100%;margin-bottom:8px;" />
            <textarea name="complete_text" style="width:100%;margin-bottom:8px;">${t.complete_text || ''}</textarea>
            <input name="image" value="${t.image || ''}" style="width:100%;margin-bottom:8px;" />
            <button type="submit">Salvar</button>
          </form>
        </div>
      `;
      document.getElementById('form-editar-texto').onsubmit = async function(e) {
        e.preventDefault();
        const { title, complete_text, image } = this;
        await supabase.from('text').update({ 
          title: title.value, 
          complete_text: complete_text.value, 
          image: image.value 
        }).eq('id', id);
        const { data: textos } = await supabase.from('text').select('*').eq('id_disciplina', t.id_disciplina);
        window.ultimoTextosExibidos = textos;
        renderConteudoAtual(textos, t.id_disciplina);
        document.getElementById('crud-modal-root').innerHTML = '';
      };
    };
    window.excluirTexto = function(id, disciplinaId) {
      document.getElementById('crud-modal-root').innerHTML = `
        <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:4000;display:flex;align-items:center;justify-content:center;">
          <div style="background:#fff;padding:24px 20px;border-radius:10px;max-width:340px;width:90vw;box-shadow:0 2px 12px rgba(0,0,0,0.12);position:relative;text-align:center;">
            <button type="button" onclick="document.getElementById('crud-modal-root').innerHTML=''" style="position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;">&times;</button>
            <h3>Excluir Texto</h3>
            <p>Tem certeza que deseja excluir este texto?</p>
            <button onclick="confirmarExclusaoTexto(${id},${disciplinaId})" style="margin-right:12px;">Sim</button>
            <button onclick="document.getElementById('crud-modal-root').innerHTML=''">Não</button>
          </div>
        </div>
      `;
    };
    window.confirmarExclusaoTexto = async function(id, disciplinaId) {
      await supabase.from('text').delete().eq('id', id);
      const { data: textos } = await supabase.from('text').select('*').eq('id_disciplina', disciplinaId);
      window.ultimoTextosExibidos = textos;
      renderConteudoAtual(textos, disciplinaId);
      document.getElementById('crud-modal-root').innerHTML = '';
    };
    document.getElementById('extra-content-btn').onclick = function() {
      const menu = document.getElementById('extra-content-menu');
      menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
    };
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('extra-content-menu');
      const btn = document.getElementById('extra-content-btn');
      if (!menu.contains(e.target) && e.target !== btn && !btn.contains(e.target)) {
        menu.style.display = 'none';
      }
    });
    document.getElementById('menu-text-btn').onclick = function() {
      window.abaAtiva = 'text';
      const disciplinaId = window.ultimoDisciplinaIdExibida;
      if (!disciplinaId) return;
      supabase.from('text').select('*').eq('id_disciplina', disciplinaId).then(({ data: textos }) => {
        window.ultimoTextosExibidos = textos;
        renderConteudoAtual(textos, disciplinaId);
        document.getElementById('extra-content-menu').style.display = 'none';
      });
    };
    document.getElementById('menu-video-btn').onclick = async function() {
      window.abaAtiva = 'video';
      const disciplinaId = window.ultimoDisciplinaIdExibida;
      if (!disciplinaId) return;
      const conteudoDiv = document.getElementById('conteudo-texto-main');
      conteudoDiv.style.display = 'block';
      conteudoDiv.innerHTML = '<div style="text-align:center;margin:40px 0;">Carregando vídeos...</div>';
      conteudoDiv.classList.add('videos-mode');
      document.getElementById('extra-content-menu').style.display = 'none';
      // Busca vídeos
      const { data: videos, error } = await supabase.from('video').select('*').eq('id_disciplina', disciplinaId);
      if (error || !videos || videos.length === 0) {
        conteudoDiv.innerHTML = `
          <div style=\"color:#b00;font-size:1.1em;text-align:center;margin-bottom:16px;\">
            Essa disciplina ainda não tem vídeos.
          </div>
          <div style=\"text-align:center;\">
            <button onclick=\"criarVideo(${disciplinaId})\" style=\"font-size:1.1em;padding:8px 18px;border-radius:8px;background:#1976d2;color:#fff;border:none;cursor:pointer;\">➕ Adicionar Vídeo</button>
          </div>
        `;
        return;
      }
      conteudoDiv.innerHTML = videos.map(v => `
        <div class=\"registro\">
          ${editMode ? `
            <div class=\"registro-toolbar\">
              <button onclick=\"editarVideo(${v.id})\" class=\"crud-btn\" title=\"Editar\">✏️</button>
              <button onclick=\"excluirVideo(${v.id},${disciplinaId})\" class=\"crud-btn delete\" title=\"Excluir\">🗑️</button>
            </div>
          ` : ''}
          ${v.title ? `<span class=\"registro-title\">${v.title}</span>` : ''}
          ${v.video_link ? renderVideoEmbed(v.video_link) : ''}
        </div>
      `).join('') +
      (editMode ? `<button onclick=\"criarVideo(${disciplinaId})\" style=\"margin-left:8px;font-size:1em;vertical-align:middle;\">➕ Adicionar Vídeo</button>` : '');
    };
    function renderVideoEmbed(link) {
      // Se for YouTube, embeda, senão mostra link
      const ytMatch = link.match(/(?:youtu.be\/|youtube.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([\w-]{11})/);
      if (ytMatch) {
        return `<div class=\"video-responsive\"><iframe src=\"https://www.youtube.com/embed/${ytMatch[1]}\" allowfullscreen></iframe></div>`;
      }
      return `<a href=\"${link}\" target=\"_blank\" style=\"color:#1976d2;word-break:break-all;\">${link}</a>`;
    }
    window.criarVideo = function(disciplinaId) {
      document.getElementById('crud-modal-root').innerHTML = `
        <div style=\"position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:4000;display:flex;align-items:center;justify-content:center;\">
          <form id=\"form-novo-video\" style=\"background:#fff;padding:24px 20px;border-radius:10px;max-width:400px;width:90vw;box-shadow:0 2px 12px rgba(0,0,0,0.12);position:relative;\">
            <button type=\"button\" onclick=\"document.getElementById('crud-modal-root').innerHTML=''\" style=\"position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;\">&times;</button>
            <h3>Novo Vídeo</h3>
            <input name=\"title\" placeholder=\"Título\" style=\"width:100%;margin-bottom:8px;\" />
            <input name=\"video_link\" placeholder=\"Link do vídeo\" style=\"width:100%;margin-bottom:8px;\" />
            <button type=\"submit\">Salvar</button>
          </form>
        </div>
      `;
      document.getElementById('form-novo-video').onsubmit = async function(e) {
        e.preventDefault();
        const { title, video_link } = this;
        await supabase.from('video').insert([{ 
          title: title.value, 
          video_link: video_link.value, 
          id_disciplina: disciplinaId 
        }]);
        document.getElementById('crud-modal-root').innerHTML = '';
        document.getElementById('menu-video-btn').onclick(); // Recarrega vídeos
      };
    };
    window.editarVideo = function(id) {
      supabase.from('video').select('*').eq('id', id).then(({ data }) => {
        const v = data && data[0];
        if (!v) return;
        document.getElementById('crud-modal-root').innerHTML = `
          <div style=\"position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:4000;display:flex;align-items:center;justify-content:center;\">
            <form id=\"form-editar-video\" style=\"background:#fff;padding:24px 20px;border-radius:10px;max-width:400px;width:90vw;box-shadow:0 2px 12px rgba(0,0,0,0.12);position:relative;\">
              <button type=\"button\" onclick=\"document.getElementById('crud-modal-root').innerHTML=''\" style=\"position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;\">&times;</button>
              <h3>Editar Vídeo</h3>
              <input name=\"title\" value=\"${v.title || ''}\" style=\"width:100%;margin-bottom:8px;\" />
              <input name=\"video_link\" value=\"${v.video_link || ''}\" style=\"width:100%;margin-bottom:8px;\" />
              <button type=\"submit\">Salvar</button>
            </form>
          </div>
        `;
        document.getElementById('form-editar-video').onsubmit = async function(e) {
          e.preventDefault();
          const { title, video_link } = this;
          await supabase.from('video').update({
            title: title.value,
            video_link: video_link.value
          }).eq('id', id);
          document.getElementById('crud-modal-root').innerHTML = '';
          document.getElementById('menu-video-btn').onclick(); // Recarrega vídeos
        };
      });
    };
    window.excluirVideo = function(id, disciplinaId) {
      document.getElementById('crud-modal-root').innerHTML = `
        <div style=\"position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:4000;display:flex;align-items:center;justify-content:center;\">
          <div style=\"background:#fff;padding:24px 20px;border-radius:10px;max-width:340px;width:90vw;box-shadow:0 2px 12px rgba(0,0,0,0.12);position:relative;text-align:center;\">
            <button type=\"button\" onclick=\"document.getElementById('crud-modal-root').innerHTML=''\" style=\"position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;\">&times;</button>
            <h3>Excluir Vídeo</h3>
            <p>Tem certeza que deseja excluir este vídeo?</p>
            <button onclick=\"confirmarExclusaoVideo(${id},${disciplinaId})\" style=\"margin-right:12px;\">Sim</button>
            <button onclick=\"document.getElementById('crud-modal-root').innerHTML=''\">Não</button>
          </div>
        </div>
      `;
    };
    window.confirmarExclusaoVideo = async function(id, disciplinaId) {
      await supabase.from('video').delete().eq('id', id);
      document.getElementById('crud-modal-root').innerHTML = '';
      document.getElementById('menu-video-btn').onclick(); // Recarrega vídeos
    };
    document.getElementById('menu-practice-btn').onclick = async function() {
      window.abaAtiva = 'practice';
      const disciplinaId = window.ultimoDisciplinaIdExibida;
      if (!disciplinaId) return;
      const conteudoDiv = document.getElementById('conteudo-texto-main');
      conteudoDiv.style.display = 'block';
      conteudoDiv.classList.remove('videos-mode');
      conteudoDiv.innerHTML = '<div style="text-align:center;margin:40px 0;">Carregando práticas...</div>';
      document.getElementById('extra-content-menu').style.display = 'none';
      // Busca práticas
      const { data: practices, error } = await supabase.from('practice').select('*').eq('id_disciplina', disciplinaId);
      if (error || !practices || practices.length === 0) {
        conteudoDiv.innerHTML = `
          <div style=\"color:#b00;font-size:1.1em;text-align:center;margin-bottom:16px;\">
            Essa disciplina ainda não tem práticas.
          </div>
          <div style=\"text-align:center;\">
            <button onclick=\"criarPractice(${disciplinaId})\" style=\"font-size:1.1em;padding:8px 18px;border-radius:8px;background:#1976d2;color:#fff;border:none;cursor:pointer;\">➕ Adicionar Prática</button>
          </div>
        `;
        return;
      }
      conteudoDiv.innerHTML = practices.map(p => `
        <div class=\"registro\">
          ${editMode ? `
            <div class=\"registro-toolbar\">
              <button onclick=\"editarPractice(${p.id})\" class=\"crud-btn\" title=\"Editar\">✏️</button>
              <button onclick=\"excluirPractice(${p.id},${disciplinaId})\" class=\"crud-btn delete\" title=\"Excluir\">🗑️</button>
            </div>
          ` : ''}
          ${p.tipo ? `<span class=\"registro-title\">${p.tipo}</span>` : ''}
          ${p.texto ? `<span class=\"registro-text\">${p.texto}</span>` : ''}
          ${p.link ? `<a href=\"${p.link}\" target=\"_blank\" style=\"color:#1976d2;word-break:break-all;display:block;margin-top:6px;\">🔗 Link</a>` : ''}
        </div>
      `).join('') +
      (editMode ? `<button onclick=\"criarPractice(${disciplinaId})\" style=\"margin-left:8px;font-size:1em;vertical-align:middle;\">➕ Adicionar Prática</button>` : '');
    };
    window.criarPractice = function(disciplinaId) {
      document.getElementById('crud-modal-root').innerHTML = `
        <div style=\"position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:4000;display:flex;align-items:center;justify-content:center;\">
          <form id=\"form-novo-practice\" style=\"background:#fff;padding:24px 20px;border-radius:10px;max-width:400px;width:90vw;box-shadow:0 2px 12px rgba(0,0,0,0.12);position:relative;\">
            <button type=\"button\" onclick=\"document.getElementById('crud-modal-root').innerHTML=''\" style=\"position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;\">&times;</button>
            <h3>Nova Prática</h3>
            <select name=\"tipo\" style=\"width:100%;margin-bottom:8px;\">
              <option value=\"texto\">Texto</option>
              <option value=\"imagem\">Imagem</option>
              <option value=\"video\">Vídeo</option>
            </select>
            <textarea name=\"texto\" placeholder=\"Descrição\" style=\"width:100%;margin-bottom:8px;\"></textarea>
            <input name=\"link\" placeholder=\"Link (opcional)\" style=\"width:100%;margin-bottom:8px;\" />
            <button type=\"submit\">Salvar</button>
          </form>
        </div>
      `;
      document.getElementById('form-novo-practice').onsubmit = async function(e) {
        e.preventDefault();
        const { tipo, texto, link } = this;
        await supabase.from('practice').insert([{ 
          tipo: tipo.value, 
          texto: texto.value, 
          link: link.value, 
          id_disciplina: disciplinaId 
        }]);
        document.getElementById('crud-modal-root').innerHTML = '';
        document.getElementById('menu-practice-btn').onclick(); // Recarrega práticas
      };
    };
    window.editarPractice = function(id) {
      supabase.from('practice').select('*').eq('id', id).then(({ data }) => {
        const p = data && data[0];
        if (!p) return;
        document.getElementById('crud-modal-root').innerHTML = `
          <div style=\"position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:4000;display:flex;align-items:center;justify-content:center;\">
            <form id=\"form-editar-practice\" style=\"background:#fff;padding:24px 20px;border-radius:10px;max-width:400px;width:90vw;box-shadow:0 2px 12px rgba(0,0,0,0.12);position:relative;\">
              <button type=\"button\" onclick=\"document.getElementById('crud-modal-root').innerHTML=''\" style=\"position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;\">&times;</button>
              <h3>Editar Prática</h3>
              <select name=\"tipo\" style=\"width:100%;margin-bottom:8px;\">
                <option value=\"texto\" ${p.tipo === 'texto' ? 'selected' : ''}>Texto</option>
                <option value=\"imagem\" ${p.tipo === 'imagem' ? 'selected' : ''}>Imagem</option>
                <option value=\"video\" ${p.tipo === 'video' ? 'selected' : ''}>Vídeo</option>
              </select>
              <textarea name=\"texto\" style=\"width:100%;margin-bottom:8px;\">${p.texto || ''}</textarea>
              <input name=\"link\" value=\"${p.link || ''}\" style=\"width:100%;margin-bottom:8px;\" />
              <button type=\"submit\">Salvar</button>
            </form>
          </div>
        `;
        document.getElementById('form-editar-practice').onsubmit = async function(e) {
          e.preventDefault();
          const { tipo, texto, link } = this;
          await supabase.from('practice').update({
            tipo: tipo.value,
            texto: texto.value,
            link: link.value
          }).eq('id', id);
          document.getElementById('crud-modal-root').innerHTML = '';
          document.getElementById('menu-practice-btn').onclick(); // Recarrega práticas
        };
      });
    };
    window.excluirPractice = function(id, disciplinaId) {
      document.getElementById('crud-modal-root').innerHTML = `
        <div style=\"position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:4000;display:flex;align-items:center;justify-content:center;\">
          <div style=\"background:#fff;padding:24px 20px;border-radius:10px;max-width:340px;width:90vw;box-shadow:0 2px 12px rgba(0,0,0,0.12);position:relative;text-align:center;\">
            <button type=\"button\" onclick=\"document.getElementById('crud-modal-root').innerHTML=''\" style=\"position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;cursor:pointer;\">&times;</button>
            <h3>Excluir Prática</h3>
            <p>Tem certeza que deseja excluir esta prática?</p>
            <button onclick=\"confirmarExclusaoPractice(${id},${disciplinaId})\" style=\"margin-right:12px;\">Sim</button>
            <button onclick=\"document.getElementById('crud-modal-root').innerHTML=''\">Não</button>
          </div>
        </div>
      `;
    };
    window.confirmarExclusaoPractice = async function(id, disciplinaId) {
      await supabase.from('practice').delete().eq('id', id);
      document.getElementById('crud-modal-root').innerHTML = '';
      document.getElementById('menu-practice-btn').onclick(); // Recarrega práticas
    };
    </script>
</body>
</html>
